name: Benchmarks

on:
  push:
    branches: [main]

permissions:
  contents: write
  pages: write

jobs:
  benchmark:
    name: Run benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Run benchmarks
        run: go test -bench=. -benchmem -count=1 -benchtime=200ms ./... 2>&1 | tee bench-output.txt

      - name: Build gobenchdata tool
        run: go build -o gobenchdata .

      - name: Fetch gh-pages branch
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true

      - name: Checkout gh-pages branch
        run: |
          BENCH_OUTPUT="$(pwd)/bench-output.txt"
          TOOL_BIN="$(pwd)/gobenchdata"

          COMMIT_SHA="${GITHUB_SHA}"
          COMMIT_MSG="$(git log -1 --format='%s' "$COMMIT_SHA")"
          COMMIT_AUTHOR="$(git log -1 --format='%an' "$COMMIT_SHA")"
          COMMIT_DATE="$(git log -1 --format='%aI' "$COMMIT_SHA")"
          COMMIT_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/commit/${COMMIT_SHA}"
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          BRANCH="${GITHUB_REF_NAME}"

          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            git commit --allow-empty -m "Initialize GitHub Pages branch for benchmarks"
          fi

          mkdir -p dev/bench

          "$TOOL_BIN" \
            -output-file="$BENCH_OUTPUT" \
            -branch="$BRANCH" \
            -data-dir=dev/bench \
            -commit-sha="$COMMIT_SHA" \
            -commit-msg="$COMMIT_MSG" \
            -commit-author="$COMMIT_AUTHOR" \
            -commit-date="$COMMIT_DATE" \
            -commit-url="$COMMIT_URL" \
            -repo-url="$REPO_URL" \
            -max-items=100

      - name: Push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add dev/bench
          git commit -m "Update benchmarks for ${GITHUB_REF_NAME} ($(echo ${GITHUB_SHA} | cut -c1-7))" || echo "No changes to commit"

          REMOTE_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git"
          git push "$REMOTE_URL" gh-pages 2>/dev/null
